---
title: "SingleSpeciesVignette"
author: "P Galante"
date: "5/26/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Single species range change metrics

Translating a species’ current distribution into meaningful conservation metrics in a repeatable and transparent way to inform conservation planning and decision-making remains an outstanding issue in conservation biology. By using a species distribution model (SDM), as well as landscape requirements (e.g., forest cover), we can reduce an SDM to only those areas likely to be suitable to estimate the species’ current range (e.g., in maskRangeR). From these reduced models, IUCN metrics regarding area of occupancy (upper bounds of AOO) and extent of occurrence (EOO) can be calculated in order to inform assessment of a species’ conservation status.  In addition, we can calculate the proportion of a species’ range size that is protected, that is threatened, or that is associated with different land cover types. If past or future model projections or geospatial data on habitat for masking  are available, we can also calculate and visualize change in these metrics over time. These change metrics can then inform redlisting and forward-thinking conservation planning. Beyond single species, we can combine models from multiple species to calculate community-level metrics of conservation interest such as richness, spatial and temporal turnover, endemism, and phylogenetic diversity, to understand complementarity across space and to further aid planning and decision-making.


```{r}
library(changeRangeR)
library(raster)
library(rgdal)
library(sf)
library(dplyr)
```
# Range size

Calculating range size is as simple as multiplying the number of cells in a binary raster by the resolution (in km) squared.
This method is especially useful when your raster is projected. For unprojected rasters, see ?raster::area

```{r}
p <-raster("inst/extdata/DemoData/SDM/Forest_suitable_projected1.tif")
# find the number of cells that are not NA
pCells <- ncell(p[!is.na(p)])
# Convert the raster resolution to km^s
Resolution <- (res(p)/1000)^2
# Multiply the two
area <- pCells * Resolution

paste0("area = ", area[1], " km^2")
```

# EOO

## EOO Occurrences

Calculate the extent of occupancy around occurrence localities

```{r EOO occs}
locs <- read.csv("inst/extdata/DemoData/locs/10KM_thin_2017.csv")
head(locs)
eoo <- mcp(locs[,1:2])
area <- area(eoo)
## area is measured in meters^2
paste0(area, " meters ^2")
```

## EOO SDM

Calculate the extent of occupancy from a thresholded SDM

```{r}
p <-raster("inst/extdata/DemoData/SDM/Climatically_suitable_projected1.tif")
# Threshold of the minimum training presence
thr <- min(values(p), na.rm=T)
p[p<thr] <- NA
p.pts <- rasterToPoints(p)
eooSDM <- mcp(p.pts[,1:2])
aeoosdm <- area(eooSDM)
paste0(aeoosdm, " meters ^2")
```

# AOO

Calculating the areas of occupancy measured in gridcells where the resolution is 2km

## AOO pre-mask

Calculate the area of occupancy 

```{r}

```

## AOO occurrence points

Calculate the area of occupancy that contains occurrence records

```{r}
p <-raster("inst/extdata/DemoData/SDM/Climatically_suitable_projected1.tif")
# Using unfiltered records
locs <- read.csv("inst/extdata/DemoData/locs/All_localities_30n.csv")
locs <- locs[,1:2]
p[!is.na(p)] <- 1
AOOlocs<-aooArea(r = p,proj = crs(p), locs = locs)

print(AOOlocs)
```

## AOO pre-masked SDM
```{r}
p <-raster("inst/extdata/DemoData/SDM/Climatically_suitable_projected1.tif")
# Convert to binary
p[!is.na(p)] <- 1
AOO<-aooArea(r = p,proj = crs(p))
print(AOO)
```

## AOO masked SDM
```{r}
p <-raster("inst/extdata/DemoData/SDM/Forest_suitable_projected1.tif")
# Convert to binary
p[!is.na(p)] <- 1
AOO<-aooArea(r = p,proj = crs(p))
print(AOO)
```

# Optimized Model Threshold

Determining the best threshold and area for the SDM. For each increment of 0.01 between a user-specified threshold and the maximum SDM 
prediction value, the prediction is thresholded to this value to make a binary raster. This raster is then converted to points, which 
are used to delineate a trial MCP. Each trial MCP is spatially intersected with the original MCP (based on the occurrence coordinates) and
the original occurrence points. The Jaccard similarity index is calculated to determine geographic similarity between the trial and 
observed MCP. The trial MCP is also spatially intersected with the original occurrence points to determine how many were omitted. The 
"best" MCP is the one that has the highest JSI and also omits the least original occurrence points.

```{r, warning=F}
p <- raster("inst/extdata/DemoData/SDM/olinguitoSDM.tif")
xy <- read.csv("inst/extdata/DemoData/locs/10KM_thin_2017.csv")
ch.orig <- mcp(xy[,1:2])
thr <- 0.3380209
SDMeoo <- mcpSDM(p = p, xy = xy[,1:2], ch.orig = ch.orig, thr = thr)
# Check the output
SDMeoo
```

# Ratio overlap

## Current 

```{r, warning = F}
r <-raster("inst/extdata/DemoData/SDM/Forest_suitable_projected1.tif")
shp <- readOGR("inst/extdata/DemoData/shapefiles", "WDPA_COL_olinguito")
field <- "DESIG_ENG"
category <- "All"
ratio.Overlap <- ratioOverlap(r = r, shp = shp, field = field, category = category)
# Look at the range that is protected
plot(ratio.Overlap$maskedRange)
# The proportion of the range that is protected
ratio.Overlap$ratio
```


## Future 

```{r}
# create list of shapefiles
shp1 <- readOGR("inst/extdata/DemoData/shapefiles", "WDPA_COL_olinguito")
shp2 <- shp1
shp3 <- shp1
shp4 <- shp1
futures <- list(shp1,shp2, shp3, shp4)
# load raster
r <-raster("inst/extdata/DemoData/SDM/Forest_suitable_projected1.tif")
r <- list(r,r,r,r)
field <- "DESIG_ENG"
category <- "All"
# supply names for r and futures
r.names <- c("r1", "r2", "r3", "r4")
futures.names <- c("f1", "f2", "f3", "f4")
# Calculate the overlap for each time period
future.ratios <- futureOverlap(r = r, futures = futures, field = field, category = category, futures.names, r.names)
## Plot
# Create list of years from which landcover comes
years <- c(2000, 2001, 2002, 2003)
# Plot
plot(x = future.ratios, y = years, type = "b", main = "Percent of SDM predicted to be protected")
```
